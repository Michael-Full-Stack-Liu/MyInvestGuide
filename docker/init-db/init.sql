-- =============================================================================
-- PostgreSQL 初始化脚本
-- =============================================================================
-- 此脚本仅在容器首次启动时执行
-- 用于创建 MLflow 和其他服务所需的数据库和用户
-- =============================================================================

-- 显示当前连接信息
\echo '=================================================='
\echo '正在初始化 Congress Trading MLOps 数据库...'
\echo '=================================================='

-- -----------------------------------------------------------------------------
-- 1. 创建额外的数据库 (如果需要)
-- -----------------------------------------------------------------------------
-- 注意: 主数据库 (mlflow_db) 已通过环境变量 POSTGRES_DB 自动创建

-- 如果将来需要为 Evidently 创建独立数据库，取消下面的注释
-- CREATE DATABASE evidently_db;

-- -----------------------------------------------------------------------------
-- 2. 安装扩展 (可选)
-- -----------------------------------------------------------------------------
-- 切换到 mlflow_db 数据库
\c mlflow_db

-- 启用 UUID 扩展 (某些 MLflow 版本可能需要)
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 启用 pg_stat_statements 用于查询性能分析 (可选)
-- CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- -----------------------------------------------------------------------------
-- 3. 创建只读用户 (可选，用于监控/报表)
-- -----------------------------------------------------------------------------
-- 如果需要创建只读用户，取消下面的注释
-- CREATE USER readonly_user WITH PASSWORD 'readonly_password';
-- GRANT CONNECT ON DATABASE mlflow_db TO readonly_user;
-- GRANT USAGE ON SCHEMA public TO readonly_user;
-- GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;
-- ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO readonly_user;

-- -----------------------------------------------------------------------------
-- 4. 完成
-- -----------------------------------------------------------------------------
\echo '=================================================='
\echo '数据库初始化完成!'
\echo '已创建: mlflow_db'
\echo '=================================================='
