# =============================================================================
# Docker Compose Configuration for Congress Trading Prediction MLOps Stack
# =============================================================================
#
# 使用方法:
#   启动所有服务:     docker compose up -d
#   启动单个服务:     docker compose up -d postgres
#   查看日志:         docker compose logs -f [service_name]
#   停止所有服务:     docker compose down
#   停止并删除数据:   docker compose down -v
#
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  # 用途: MLflow 元数据存储
  # 端口: 5432
  # ===========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: congress_postgres
    restart: unless-stopped

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    environment:
      POSTGRES_USER: ${POSTGRES_USER:-mlflow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mlflow_password}
      POSTGRES_DB: ${POSTGRES_DB:-mlflow_db}

    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mlflow} -d ${POSTGRES_DB:-mlflow_db}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - mlops_network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # MLflow Tracking Server
  # ===========================================================================
  # 用途: 实验追踪、模型版本管理
  # UI: http://localhost:5000
  # ===========================================================================
  mlflow:
    build:
      context: .
      dockerfile: Dockerfile.mlflow
    container_name: congress_mlflow
    restart: unless-stopped

    depends_on:
      postgres:
        condition: service_healthy

    ports:
      - "${MLFLOW_PORT:-5000}:5000"

    environment:
      MLFLOW_BACKEND_STORE_URI: postgresql://${POSTGRES_USER:-mlflow}:${POSTGRES_PASSWORD:-mlflow_password}@postgres:5432/${POSTGRES_DB:-mlflow_db}
      MLFLOW_ARTIFACTS_DESTINATION: /mlflow/artifacts

    volumes:
      - ../mlruns:/mlflow/artifacts

    command: >
      mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri postgresql://${POSTGRES_USER:-mlflow}:${POSTGRES_PASSWORD:-mlflow_password}@postgres:5432/${POSTGRES_DB:-mlflow_db} --default-artifact-root /mlflow/artifacts --serve-artifacts

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - mlops_network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =============================================================================
# 数据卷定义
# =============================================================================
volumes:
  postgres_data:
    name: congress_postgres_data
    driver: local

# =============================================================================
# 网络定义
# =============================================================================
networks:
  mlops_network:
    name: congress_mlops_network
    driver: bridge
